<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pausa de Contratos</title>
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/sejafibra/agenda/refs/heads/main/faviconsf.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { background-color:#f8f9fa; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .logo { height:50px; margin:10px 0; }
    .card { border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,.1); margin-bottom:20px; }
    .card-header { background-color:#0d6efd; color:white; border-radius:10px 10px 0 0!important; }
    .status-badge { padding:5px 10px; border-radius:20px; font-size:.8rem; font-weight:bold; }
    .status-active { background:#d1e7dd; color:#0f5132; }
    .status-ending { background:#fff3cd; color:#664d03; }
    .status-expired { background:#f8d7da; color:#842029; }
    .btn-action { padding:0.25rem 0.5rem; font-size:.8rem; }
    .login-container { max-width:400px; margin:0 auto; padding-top:50px; }
  </style>
</head>
<body>
<div class="container-fluid">
  <!-- Cabeçalho -->
  <div class="row justify-content-center">
    <div class="col-md-10 text-center">
      <img src="https://sejafibra.net/wp-content/uploads/2023/06/logonovofibra.png" class="logo">
      <h2 class="mb-4">Pausa de Contratos</h2>
    </div>
  </div>

  <!-- Login -->
  <div id="loginSection" class="login-container">
    <div class="card">
      <div class="card-header text-center"><h5>Login</h5></div>
      <div class="card-body">
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="loginEmail" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Senha</label>
            <input type="password" id="loginPassword" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Entrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Conteúdo -->
  <div id="mainContent" style="display:none;">
    <div class="row justify-content-center">
      <div class="col-md-10">

        <!-- Seletor Cidade -->
        <div class="card mb-4">
          <div class="card-header"><h5>Filtrar Cidade</h5></div>
          <div class="card-body">
            <select id="citySelector" class="form-select">
              <option value="Ubatuba">Ubatuba</option>
              <option value="Caraguá">Caraguá</option>
            </select>
          </div>
        </div>

        <!-- Formulário -->
        <div class="card mb-4">
          <div class="card-header"><h5>Cadastrar Pausa de Contrato</h5></div>
          <div class="card-body">
            <form id="pauseForm">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Nº Contrato</label>
                  <input type="text" id="contractNumber" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Nome do Cliente</label>
                  <input type="text" id="clientName" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Início da Pausa</label>
                  <input type="date" id="pauseStart" class="form-control" required>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary" id="submitBtn">Cadastrar</button>
                <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display:none;">Cancelar Edição</button>
                <input type="hidden" id="editId">
              </div>
            </form>
          </div>
        </div>

        <!-- Tabela -->
        <div class="card">
          <div class="card-header"><h5>Clientes em Pausa - <span id="currentCityDisplay">Ubatuba</span></h5></div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Nº Contrato</th>
                    <th>Nome do Cliente</th>
                    <th>Início</th>
                    <th>Término</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="clientsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBOQnjqE87eF_wOr63TOfiYm4DF25n2vXM",
  authDomain: "pausa-6784a.firebaseapp.com",
  projectId: "pausa-6784a",
  storageBucket: "pausa-6784a.firebasestorage.app",
  messagingSenderId: "16089451977",
  appId: "1:16089451977:web:b22995a0bd79c5d9876c18"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const loginSection=document.getElementById("loginSection");
const mainContent=document.getElementById("mainContent");
const loginForm=document.getElementById("loginForm");
const loginEmail=document.getElementById("loginEmail");
const loginPassword=document.getElementById("loginPassword");
const pauseForm=document.getElementById("pauseForm");
const contractNumber=document.getElementById("contractNumber");
const clientName=document.getElementById("clientName");
const pauseStart=document.getElementById("pauseStart");
const clientsTableBody=document.getElementById("clientsTableBody");
const citySelector=document.getElementById("citySelector");
const currentCityDisplay=document.getElementById("currentCityDisplay");
const submitBtn=document.getElementById("submitBtn");
const cancelEditBtn=document.getElementById("cancelEditBtn");
const editId=document.getElementById("editId");

let selectedCity="Ubatuba";
let clientsData={};

// utilidades
function formatDate(d){const dt=new Date(d);return dt.toLocaleDateString("pt-BR");}
function endDate(start){const d=new Date(start);d.setDate(d.getDate()+120);return d.toISOString().split("T")[0];}
function daysRemaining(end){return Math.ceil((new Date(end)-new Date())/(1000*60*60*24));}
function getStatus(end){const d=daysRemaining(end);if(d>10)return"active";if(d>=0)return"ending";return"expired";}

// tabela
function renderTable(){
  clientsTableBody.innerHTML="";
  let arr=[];
  Object.entries(clientsData).forEach(([id,c])=>{
    if(c.city===selectedCity) arr.push({...c,id});
  });
  arr.sort((a,b)=>new Date(endDate(a.pauseStart))-new Date(endDate(b.pauseStart)));
  arr.forEach(c=>{
    const e=endDate(c.pauseStart);
    const st=getStatus(e);
    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${c.contractNumber}</td>
      <td>${c.clientName}</td>
      <td>${formatDate(c.pauseStart)}</td>
      <td>${formatDate(e)}</td>
      <td><span class="status-badge ${st==="active"?"status-active":st==="ending"?"status-ending":"status-expired"}">
        ${st==="active"?"No prazo":st==="ending"?"Terminando":"Expirado"} (${Math.abs(daysRemaining(e))} dias)
      </span></td>
      <td>
        <button class="btn btn-sm btn-warning btn-action" onclick="editClient('${c.id}')"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-danger btn-action" onclick="deleteClient('${c.id}')"><i class="bi bi-trash"></i></button>
      </td>`;
    clientsTableBody.appendChild(row);
  });
}

// CRUD
pauseForm.addEventListener("submit",e=>{
  e.preventDefault();
  const data={contractNumber:contractNumber.value.trim(),clientName:clientName.value.trim(),pauseStart:pauseStart.value,city:selectedCity};
  if(editId.value){db.ref("pausas/"+editId.value).set(data).then(()=>{alert("Atualizado!");pauseForm.reset();editId.value="";submitBtn.textContent="Cadastrar";cancelEditBtn.style.display="none";});}
  else{db.ref("pausas").push(data).then(()=>{alert("Cadastrado!");pauseForm.reset();});}
});
function editClient(id){const c=clientsData[id];contractNumber.value=c.contractNumber;clientName.value=c.clientName;pauseStart.value=c.pauseStart;editId.value=id;submitBtn.textContent="Atualizar";cancelEditBtn.style.display="inline-block";}
cancelEditBtn.addEventListener("click",()=>{pauseForm.reset();editId.value="";submitBtn.textContent="Cadastrar";cancelEditBtn.style.display="none";});
function deleteClient(id){if(confirm("Excluir pausa?"))db.ref("pausas/"+id).remove();}

// login
loginForm.addEventListener("submit",e=>{
  e.preventDefault();
  auth.signInWithEmailAndPassword(loginEmail.value,loginPassword.value).then(u=>{
    loginSection.style.display="none";mainContent.style.display="block";loadData();
  }).catch(err=>alert(err.message));
});
function loadData(){db.ref("pausas").on("value",snap=>{clientsData=snap.val()||{};renderTable();});}
citySelector.addEventListener("change",e=>{selectedCity=e.target.value;currentCityDisplay.textContent=selectedCity;renderTable();});
auth.onAuthStateChanged(u=>{if(u){loginSection.style.display="none";mainContent.style.display="block";loadData();}});
</script>
</body>
</html>
